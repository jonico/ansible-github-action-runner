---
- name: Run whoami to find out the current user
  command: whoami
  changed_when: false
  become: false
  register: whoami

- name: Set a fact with the user name.
  set_fact:
    login_user: "{{ whoami.stdout }}"

- name: Download Runner Package
  get_url:
    url: "{{ runner_download_base_url }}/v{{ runner_version }}/actions-runner-linux-x64-{{ runner_version }}.tar.gz"
    dest: /tmp/actions-runner-{{ runner_version }}.tar.gz

- name: Create runner install folder
  file:
    path: "{{ runner_install_folder }}"
    state: directory
    owner: "{{ login_user }}"
    mode: '0755'
  become: true

- name: Create runner workspace folder
  file:
    path: "{{ runner_work_folder }}"
    state: directory
    owner: "{{ login_user }}"
    mode: '0755'
  become: true

- name: Unarchive Actions Runner package
  shell: |
    tar xvf /tmp/actions-runner-{{ runner_version }}.tar.gz -C {{ runner_install_folder }}
  become: true

- name: Make file permissions ok
  file:
    path: "{{ runner_install_folder }}"
    owner:  "{{ login_user }}"
    mode: 0755
  become: true

- name: Configure Runner
  shell: |
    {{ runner_install_folder }}/config.sh --unattended --url {{ runner_config_repo_url }} --token {{ runner_config_token }} --name {{ runner_config_name }} --work {{ runner_work_folder }} --labels "{{ runner_config_labels | replace('', '-') }}"  --replace --runasservice
  when: runner_config_token 

- name: Run runner as service
  shell: |
    {{ runner_install_folder }}/svc.sh install
  when: runner_config_token     
  become: true